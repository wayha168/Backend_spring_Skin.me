<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:fragment="layout(content, head, scripts)">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:text="${pageTitle} ?: 'SkinMe'">SkinMe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/layout.css}" />
    <th:block th:replace="${head}"></th:block>
  </head>
  <body>
    <div class="app-shell">
      <div class="app-sidebar" th:replace="components/sidebar :: sidebar"></div>
      <main class="app-content" th:replace="${content}"></main>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
    
    <script>
      // Global Toast Notification System
      function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.cssText = `
          background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
          color: white;
          padding: 16px 20px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          margin-bottom: 10px;
          min-width: 300px;
          max-width: 400px;
          display: flex;
          align-items: center;
          gap: 12px;
          animation: slideInRight 0.3s ease-out;
          cursor: pointer;
        `;
        
        const icon = type === 'success' ? 'bi-check-circle' : 
                     type === 'error' ? 'bi-x-circle' : 
                     type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle';
        
        toast.innerHTML = `
          <i class="bi ${icon}" style="font-size: 20px;"></i>
          <span style="flex: 1; font-weight: 500;">${message}</span>
          <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.8;">&times;</button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after duration
        setTimeout(() => {
          toast.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
        }, duration);
        
        // Click to dismiss
        toast.addEventListener('click', () => {
          toast.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
        });
      }
      
      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOutRight {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    </script>
    
    <!-- Logout Form (single instance for entire app) -->
    <form id="logoutForm" th:action="@{/logout}" method="POST" style="display: none">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>
    
    <th:block th:replace="${scripts}"></th:block>
    
    <!-- Global Logout Function -->
    <script>
      // Global logout function - ensures single instance
      window.handleLogout = function(event) {
        if (event) {
          event.preventDefault();
        }
        
        if (typeof showToast === 'function') {
          showToast('Logging out...', 'info');
        }
        
        // Find logout form
        const logoutForm = document.getElementById('logoutForm');
        if (!logoutForm) {
          console.error('Logout form not found');
          // Fallback: direct redirect
          window.location.href = '/logout';
          return;
        }
        
        // Ensure CSRF token is present
        let csrfInput = logoutForm.querySelector('input[name="_csrf"]');
        if (!csrfInput) {
          // Try to get from meta tag
          const csrfMeta = document.querySelector('meta[name="_csrf"]');
          if (csrfMeta) {
            csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfMeta.getAttribute('content') || csrfMeta.content;
            logoutForm.appendChild(csrfInput);
          }
        }
        
        // Clear all cookies
        document.cookie.split(';').forEach(function(c) {
          const cookieName = c.split('=')[0].trim();
          if (cookieName) {
            document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;';
            document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=' + window.location.hostname + ';';
          }
        });
        
        // Clear localStorage
        try {
          localStorage.clear();
        } catch (e) {
          console.warn('Failed to clear localStorage:', e);
        }
        
        // Clear sessionStorage
        try {
          sessionStorage.clear();
        } catch (e) {
          console.warn('Failed to clear sessionStorage:', e);
        }
        
        // Submit logout form
        try {
          logoutForm.submit();
        } catch (e) {
          console.error('Failed to submit logout form:', e);
          // Fallback: direct redirect
          window.location.href = '/logout';
        }
      };
    </script>
  </body>
</html>
